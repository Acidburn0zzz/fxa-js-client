!function(e,t){"function"==typeof define&&define.amd?define([],t):e.FxAccountClient=t()}(this,function(){var e,t,n;return function(r){function o(e,t){return w.call(e,t)}function i(e,t){var n,r,o,i,s,u,c,a,l,f,h=t&&t.split("/"),d=g.map,p=d&&d["*"]||{};if(e&&"."===e.charAt(0))if(t){for(h=h.slice(0,h.length-1),e=h.concat(e.split("/")),a=0;a<e.length;a+=1)if(f=e[a],"."===f)e.splice(a,1),a-=1;else if(".."===f){if(1===a&&(".."===e[2]||".."===e[0]))break;a>0&&(e.splice(a-1,2),a-=2)}e=e.join("/")}else 0===e.indexOf("./")&&(e=e.substring(2));if((h||p)&&d){for(n=e.split("/"),a=n.length;a>0;a-=1){if(r=n.slice(0,a).join("/"),h)for(l=h.length;l>0;l-=1)if(o=d[h.slice(0,l).join("/")],o&&(o=o[r])){i=o,s=a;break}if(i)break;!u&&p&&p[r]&&(u=p[r],c=a)}!i&&u&&(i=u,s=c),i&&(n.splice(0,s,i),e=n.join("/"))}return e}function s(e,t){return function(){return d.apply(r,T.call(arguments,0).concat([e,t]))}}function u(e){return function(t){return i(t,e)}}function c(e){return function(t){y[e]=t}}function a(e){if(o(v,e)){var t=v[e];delete v[e],k[e]=!0,h.apply(r,t)}if(!o(y,e)&&!o(k,e))throw new Error("No "+e);return y[e]}function l(e){var t,n=e?e.indexOf("!"):-1;return n>-1&&(t=e.substring(0,n),e=e.substring(n+1,e.length)),[t,e]}function f(e){return function(){return g&&g.config&&g.config[e]||{}}}var h,d,p,m,y={},v={},g={},k={},w=Object.prototype.hasOwnProperty,T=[].slice;p=function(e,t){var n,r=l(e),o=r[0];return e=r[1],o&&(o=i(o,t),n=a(o)),o?e=n&&n.normalize?n.normalize(e,u(t)):i(e,t):(e=i(e,t),r=l(e),o=r[0],e=r[1],o&&(n=a(o))),{f:o?o+"!"+e:e,n:e,pr:o,p:n}},m={require:function(e){return s(e)},exports:function(e){var t=y[e];return"undefined"!=typeof t?t:y[e]={}},module:function(e){return{id:e,uri:"",exports:y[e],config:f(e)}}},h=function(e,t,n,i){var u,l,f,h,d,g,w=[];if(i=i||e,"function"==typeof n){for(t=!t.length&&n.length?["require","exports","module"]:t,d=0;d<t.length;d+=1)if(h=p(t[d],i),l=h.f,"require"===l)w[d]=m.require(e);else if("exports"===l)w[d]=m.exports(e),g=!0;else if("module"===l)u=w[d]=m.module(e);else if(o(y,l)||o(v,l)||o(k,l))w[d]=a(l);else{if(!h.p)throw new Error(e+" missing "+l);h.p.load(h.n,s(i,!0),c(l),{}),w[d]=y[l]}f=n.apply(y[e],w),e&&(u&&u.exports!==r&&u.exports!==y[e]?y[e]=u.exports:f===r&&g||(y[e]=f))}else e&&(y[e]=n)},e=t=d=function(e,t,n,o,i){return"string"==typeof e?m[e]?m[e](t):a(p(e,t).f):(e.splice||(g=e,t.splice?(e=t,t=n,n=null):e=r),t=t||function(){},"function"==typeof n&&(n=o,o=i),o?h(r,e,t,n):setTimeout(function(){h(r,e,t,n)},4),d)},d.config=function(e){return g=e,g.deps&&d(g.deps,g.callback),d},n=function(e,t,n){t.splice||(n=t,t=[]),o(y,e)||o(v,e)||(v[e]=[e,t,n])},n.amd={jQuery:!0}}(),n("components/almond/almond",function(){}),n("sjcl",[],function(){"use strict";return sjcl}),function(e){"undefined"!=typeof module&&module&&module.exports?module.exports=e():"function"==typeof n&&n.amd?n("p",e):P=e()}(function(){"use strict";function e(e){if(!e.stack)try{throw e}catch(t){}return e}function n(){var e=D(new Error).stack;if(!e)return null;var t=[i(e,1)];return G&&(t=t.concat(G),128===t.length&&t.pop()),t}function r(e){var t=/at .+ \((.+):(\d+):(?:\d+)\)$/.exec(e)||/at ([^ ]+):(\d+):(?:\d+)$/.exec(e)||/@(.+):(\d+):(?:\d+)$/.exec(e);return t?{fileName:t[1],lineNumber:Number(t[2])}:null}function o(){var e=D(new Error).stack;if(!e)return 0;var t=e.split("\n"),n=t[0].indexOf("@")>0?t[1]:t[2],o=r(n);return o?(z=o.fileName,o.lineNumber):0}function i(e,t){for(var n=e.split("\n"),r=[],o=0|t,i=n.length;i>o;++o){var c=n[o];!c||s(c)||u(c)||r.push(c)}return r.join("\n")}function s(e){return-1!==e.indexOf("(module.js:")||-1!==e.indexOf("(node.js:")}function u(e){var t=r(e);return!!t&&t.fileName===z&&t.lineNumber>=V&&t.lineNumber<=ve}function c(e){if(e instanceof Error){var t=e.stack;if(t){if(~t.indexOf(Q))return}else t=D(e).stack;t&&(e.stack=[i(t,0)].concat(G||[]).join(Q))}}function a(){this.f=null,this.a=null,this.b=null,this.next=null}function l(e){return"object"===e||"function"===e}function f(){if(ie.length)throw ie.shift()}function h(){for(;ee!==te;){var e=ee=ee.next;re>=1024?te.next=te.next.next:++re;var t=e.f,n=e.a,r=e.b;e.f=null,e.a=null,e.b=null,t(n,r)}ne=!1,G=null}function d(e,t,n){var r=te.next;r===ee?(te.next=r=new a,r.next=ee):--re,te=r,r.f=e,r.a=t,r.b=n,ne||(ne=!0,oe())}function p(){var e=process.domain;e&&(J||(J=(1,t)("domain")),J.active=process.domain=null),ne&&Y?setImmediate(h):process.nextTick(h),e&&(J.active=process.domain=e)}function m(e){var t=1,n=document.createTextNode(""),r=new Z(e);return r.observe(n,{characterData:!0}),function(){t=-t,n.data=t}}function y(e){return function(){function t(){clearTimeout(n),clearInterval(r),e()}var n=setTimeout(t,0),r=setInterval(t,50)}}function v(e){if(!g.onerror)throw e;(1,g.onerror)(e)}function g(e){return e instanceof I?e:_(new I,e)}function k(e,t){e._state>0||(e._state=ae,e._value=t,e._domain=null,O(e))}function w(e,t){e._state>0||(G&&c(t),e._state=le,e._value=t,X&&(e._domain=process.domain),e._op===pe?$(t):O(e))}function T(e,t){t._state>0||(t._state=e._state,t._value=e._value,t._domain=e._domain,O(t))}function _(e,t){if(e._state>0)return e;if(t instanceof I)b(e,t);else{var n=typeof t;"object"===n&&null!==t||"function"===n?x(e,t):k(e,t)}return e}function b(e,t){t===e?w(e,new TypeError("You can't resolve a promise with itself")):t._state>0?T(t,e):P(t,he,e)}function x(e,t){var n=C(e,t);"function"==typeof n?S(E(e,!1),n,t):k(e,t)}function C(e,t){try{return t.then}catch(n){return w(e,n),null}}function S(e,t,n){try{ue.call(t,n,e.resolve,e.reject)}catch(r){e.reject(r)}}function O(e){null!==e._pending&&(B(e,e._op,e._pending),e._pending=null)}function B(e,t,n){if(t>=0)n._cb(e,t);else if(t===fe)n(e);else if(t===he)d(q,e,n);else for(var r=0,o=n.length;o>r;r+=2)B(e,n[r],n[r+1])}function P(e,t,n){e._state>0?B(e,t,n):null===e._pending?(e._pending=n,e._op=t):e._op===de?e._pending.push(t,n):(e._pending=[e._op,e._pending,t,n],e._op=de)}function q(e,t){var n=e._state===ae?t._cb:t._eb;t._cb=null,t._eb=null,t._trace&&(G=t._trace,t._trace=null),null===n?T(e,t):A(t,n,e._value,e._domain||t._domain)}function A(e,t,n,r){if(r){if(r._disposed)return;r.enter()}try{n=t(n)}catch(o){w(e,o),e=null}e&&_(e,n),r&&r.exit()}function E(e,t){function r(n,r){if(e){var i=e;e=null,o&&(G?o=null:G=o),n?w(i,t?n:r):_(i,r),o&&(G=o=null)}}var o=g.longStackSupport?n():null;return t?r:{promise:e,resolve:function(e){r(!1,e)},reject:function(e){r(!0,e)}}}function K(){return E(new I,!1)}function j(e){var t=new I;return w(t,e),t}function I(){this._state=0,this._value=void 0,this._domain=null,this._cb=null,this._eb=null,this._op=0,this._pending=null,this._trace=null}function M(e,t){this._value[t]=e.inspect(),0===++this._state&&(null===this._pending?this._state=ae:d(k,this,this._value))}function F(e,t){this._state<0&&(e._state===le?(this._state=0,null===this._pending?T(e,this):d(T,e,this)):(this._value[t]=e._value,0===++this._state&&(null===this._pending?this._state=ae:d(k,this,this._value))))}function N(e){var t=new I;t._cb=ye?M:F,ye=!1;var n=0|e.length;t._state=n?-n:ae,t._value=new Array(n);for(var r=0;n>r&&t._state<0;++r)P(g(e[r]),r,t);return t}function R(e){return ye=!0,N(e)}function U(e,t,n){return N(e).then(function(e){return ce.call(t,void 0,e)},n)}function H(e){function t(t){return ue.apply(e,t)}return function(){var e=arguments.length,n=new Array(e+1);n[0]=this;for(var r=0;e>r;++r)n[r+1]=arguments[r];return N(n).then(t)}}function L(e){return function(){var t=new I,n=arguments.length,r=new Array(n+1);for(r[n]=E(t,!0);n--;)r[n]=arguments[n];return W(t,e,this,r),t}}function W(e,t,n,r){try{ce.call(t,n,r)}catch(o){w(e,o)}}var z,D=e,V=o(),G=null;(new Error).stack&&(D=function(e){return e});var $,J,Q="\nFrom previous event:\n",X=l(typeof process)&&null!=process&&"[object process]"==={}.toString.call(process),Y="function"==typeof setImmediate,Z=l(typeof MutationObserver)&&MutationObserver||l(typeof WebKitMutationObserver)&&WebKitMutationObserver,ee=new a,te=ee,ne=!1,re=0,oe=X?p:Z?m(h):y(h),ie=[],se=y(f),ue=l.call,ce=l.apply;te.next=ee,$=X?function(e){throw G=null,oe(),e}:function(e){ie.push(e),se()};var ae=1,le=2,fe=-1,he=-2,de=-3,pe=-4,me=g(void 0);g.longStackSupport=!1,g.defer=K,g.reject=j,I.prototype.then=function(e,t){var r=new I;return r._cb="function"==typeof e?e:null,r._eb="function"==typeof t?t:null,g.longStackSupport&&(r._trace=n()),X&&(r._domain=process.domain),this._state>0?d(q,this,r):P(this,he,r),r},I.prototype.done=function(e,t){var n=this;(e||t)&&(n=n.then(e,t)),n.then(null,v)._op=pe},I.prototype.fail=function(e){return this.then(null,e)},I.prototype.fin=function(e){function t(){return e()}var n=this;return n.then(t,t).then(function(){return n})},I.prototype.spread=function(e,t){return this.then(N).then(function(t){return ce.call(e,void 0,t)},t)},I.prototype.timeout=function(e,t){var r=new I;if(this._state>0)T(this,r);else{var o=!1,i=g.longStackSupport?n():null,s=setTimeout(function(){o=!0,G=i,w(r,new Error(t||"Timed out after "+e+" ms")),G=null},e);P(this,fe,function(e){o||(d(T,e,r),clearTimeout(s))})}return r},I.prototype.delay=function(e){var t=new I;return P(this,fe,function(n){n._state===ae?setTimeout(function(){T(n,t)},e):d(T,n,t)}),t},I.prototype.all=function(){return this.then(N)},I.prototype.allSettled=function(){return this.then(R)},I.prototype.inspect=function(){switch(this._state){case ae:return{state:"fulfilled",value:this._value};case le:return{state:"rejected",reason:this._value};default:return{state:"pending"}}},I.prototype.nodeify=function(e){return e?void this.done(function(t){e(null,t)},e):this};var ye=!1;g.all=N,g.allSettled=R,g.spread=U,g.promised=H,g.denodeify=L,g.onerror=null,g.nextTick=function(e){me.then(function(){e.call()})._op=pe};var ve=o();return g}),n("client/lib/hawk",["sjcl"],function(e){"use strict";var t={};return t.client={header:function(e,n,r){var o={field:"",artifacts:{}};if(!e||"string"!=typeof e&&"object"!=typeof e||!n||"string"!=typeof n||!r||"object"!=typeof r)return o.err="Invalid argument type",o;var i=r.timestamp||Math.floor((t.utils.now()+(r.localtimeOffsetMsec||0))/1e3),s=r.credentials;if(!(s&&s.id&&s.key&&s.algorithm))return o.err="Invalid credential object",o;if(-1===t.utils.baseIndexOf(t.crypto.algorithms,s.algorithm))return o.err="Unknown algorithm",o;"string"==typeof e&&(e=t.utils.parseUri(e));var u={ts:i,nonce:r.nonce||t.utils.randomString(6),method:n,resource:e.relative,host:e.hostname,port:e.port,hash:r.hash,ext:r.ext,app:r.app,dlg:r.dlg};o.artifacts=u,!u.hash&&r.hasOwnProperty("payload")&&(u.hash=t.crypto.calculatePayloadHash(r.payload,s.algorithm,r.contentType));var c=t.crypto.calculateMac("header",s,u),a=null!==u.ext&&void 0!==u.ext&&""!==u.ext,l='Hawk id="'+s.id+'", ts="'+u.ts+'", nonce="'+u.nonce+(u.hash?'", hash="'+u.hash:"")+(a?'", ext="'+t.utils.escapeHeaderAttribute(u.ext):"")+'", mac="'+c+'"';return u.app&&(l+=', app="'+u.app+(u.dlg?'", dlg="'+u.dlg:"")+'"'),o.field=l,o},authenticate:function(e,n,r,o){if(o=o||{},e.getResponseHeader("www-authenticate")){var i=t.utils.parseAuthorizationHeader(e.getResponseHeader("www-authenticate"),["ts","tsm","error"]);if(!i)return!1;if(i.ts){var s=t.crypto.calculateTsMac(i.ts,n);if(s!==i.tsm)return!1;t.utils.setNtpOffset(i.ts-Math.floor((new Date).getTime()/1e3))}}if(!e.getResponseHeader("server-authorization")&&!o.required)return!0;var u=t.utils.parseAuthorizationHeader(e.getResponseHeader("server-authorization"),["mac","ext","hash"]);if(!u)return!1;var c={ts:r.ts,nonce:r.nonce,method:r.method,resource:r.resource,host:r.host,port:r.port,hash:u.hash,ext:u.ext,app:r.app,dlg:r.dlg},a=t.crypto.calculateMac("response",n,c);if(a!==u.mac)return!1;if(!o.hasOwnProperty("payload"))return!0;if(!u.hash)return!1;var l=t.crypto.calculatePayloadHash(o.payload,n.algorithm,e.getResponseHeader("content-type"));return l===u.hash},message:function(e,n,r,o){if(!e||"string"!=typeof e||!n||"number"!=typeof n||null===r||void 0===r||"string"!=typeof r||!o||"object"!=typeof o)return null;var i=o.timestamp||Math.floor((t.utils.now()+(o.localtimeOffsetMsec||0))/1e3),s=o.credentials;if(!(s&&s.id&&s.key&&s.algorithm))return null;if(-1===t.crypto.algorithms.indexOf(s.algorithm))return null;var u={ts:i,nonce:o.nonce||t.utils.randomString(6),host:e,port:n,hash:t.crypto.calculatePayloadHash(r,s.algorithm)},c={id:s.id,ts:u.ts,nonce:u.nonce,hash:u.hash,mac:t.crypto.calculateMac("message",s,u)};return c},authenticateTimestamp:function(e,n,r){var o=t.crypto.calculateTsMac(e.ts,n);return o!==e.tsm?!1:(r!==!1&&t.utils.setNtpOffset(e.ts-Math.floor((new Date).getTime()/1e3)),!0)}},t.crypto={headerVersion:"1",algorithms:["sha1","sha256"],calculateMac:function(n,r,o){var i=t.crypto.generateNormalizedString(n,o),s=new e.misc.hmac(r.key,e.hash.sha256);return s.update(i),e.codec.base64.fromBits(s.digest())},generateNormalizedString:function(e,n){var r="hawk."+t.crypto.headerVersion+"."+e+"\n"+n.ts+"\n"+n.nonce+"\n"+(n.method||"").toUpperCase()+"\n"+(n.resource||"")+"\n"+n.host.toLowerCase()+"\n"+n.port+"\n"+(n.hash||"")+"\n";return n.ext&&(r+=n.ext.replace("\\","\\\\").replace("\n","\\n")),r+="\n",n.app&&(r+=n.app+"\n"+(n.dlg||"")+"\n"),r},calculatePayloadHash:function(n,r,o){var i=new e.hash.sha256;return i.update("hawk."+t.crypto.headerVersion+".payload\n").update(t.utils.parseContentType(o)+"\n").update(n||"").update("\n"),e.codec.base64.fromBits(i.finalize())},calculateTsMac:function(n,r){var o=new e.misc.hmac(r.key,e.hash.sha256);return o.update("hawk."+t.crypto.headerVersion+".ts\n"+n+"\n"),e.codec.base64.fromBits(o.digest())}},t.utils={storage:{_cache:{},setItem:function(e,n){t.utils.storage._cache[e]=n},getItem:function(e){return t.utils.storage._cache[e]}},setStorage:function(e){var n=t.utils.getNtpOffset()||0;t.utils.storage=e,t.utils.setNtpOffset(n)},setNtpOffset:function(e){try{t.utils.storage.setItem("hawk_ntp_offset",e)}catch(n){console.error("[hawk] could not write to storage."),console.error(n)}},getNtpOffset:function(){return parseInt(t.utils.storage.getItem("hawk_ntp_offset")||"0",10)},now:function(){return(new Date).getTime()+t.utils.getNtpOffset()},escapeHeaderAttribute:function(e){return e.replace(/\\/g,"\\\\").replace(/\"/g,'\\"')},parseContentType:function(e){return e?e.split(";")[0].replace(/^\s+|\s+$/g,"").toLowerCase():""},parseAuthorizationHeader:function(e,t){if(!e)return null;var n=e.match(/^(\w+)(?:\s+(.*))?$/);if(!n)return null;var r=n[1];if("hawk"!==r.toLowerCase())return null;var o=n[2];if(!o)return null;var i={},s=o.replace(/(\w+)="([^"\\]*)"\s*(?:,\s*|$)/g,function(e,n,r){return-1===t.indexOf(n)||null===r.match(/^[ \w\!#\$%&'\(\)\*\+,\-\.\/\:;<\=>\?@\[\]\^`\{\|\}~]+$/)||i.hasOwnProperty(n)?void 0:(i[n]=r,"")});return""!==s?null:i},randomString:function(e){for(var t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",n=t.length,r=[],o=0;e>o;++o)r[o]=t[Math.floor(Math.random()*n)];return r.join("")},baseIndexOf:function(e,t,n){for(var r=(n||0)-1,o=e?e.length:0;++r<o;)if(e[r]===t)return r;return-1},parseUri:function(e){for(var t=["source","protocol","authority","userInfo","user","password","hostname","port","resource","relative","pathname","directory","file","query","fragment"],n=/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?(((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?)(?:#(.*))?)/,r=n.exec(e),o={},i=15;i--;)o[t[i]]=r[i]||"";return(null===o.port||""===o.port)&&(o.port="http"===o.protocol.toLowerCase()?"80":"https"===o.protocol.toLowerCase()?"443":""),o}},t}),n("client/lib/errors",[],function(){return{INVALID_TIMESTAMP:111,INCORRECT_EMAIL_CASE:120}}),n("client/lib/request",["./hawk","p","./errors"],function(e,t,n){"use strict";function r(e,t,n){n||(n={}),this.baseUri=e,this._localtimeOffsetMsec=n.localtimeOffsetMsec,this.xhr=t||XMLHttpRequest,this.timeout=n.timeout||3e4}return r.prototype.send=function(r,o,i,s,u){var c=t.defer(),a=new this.xhr,l=this.baseUri+r,f=null,h=this;u=u||{},s&&(f=JSON.stringify(s));try{a.open(o,l)}catch(d){return t.reject({error:"Unknown error",message:d.toString(),errno:999})}if(a.timeout=this.timeout,a.onreadystatechange=function(){if(4===a.readyState){var e=a.responseText;try{e=JSON.parse(a.responseText)}catch(t){}if(e.errno){if(e.errno!==n.INVALID_TIMESTAMP||u.retrying)return c.reject(e);var l=e.serverTime;return h._localtimeOffsetMsec=1e3*l-(new Date).getTime(),u.retrying=!0,h.send(r,o,i,s,u).then(c.resolve,c.reject)}if("undefined"==typeof a.status||200!==a.status)return 0===e.length?c.reject({error:"Timeout error",errno:999}):c.reject({error:"Unknown error",message:e,errno:999,code:a.status});c.resolve(e)}},i){var p=e.client.header(l,o,{credentials:i,payload:f,contentType:"application/json",localtimeOffsetMsec:this._localtimeOffsetMsec||0});a.setRequestHeader("authorization",p.field)}if(a.setRequestHeader("Content-Type","application/json"),u&&u.headers)for(var m in u.headers)a.setRequestHeader(m,u.headers[m]);return a.send(f),c.promise},r}),n("client/lib/hkdf",["sjcl","p"],function(e,t){"use strict";function n(n,r,o,i){var s=new e.misc.hmac(o,e.hash.sha256);s.update(n);for(var u=s.digest(),c=32,a=Math.ceil(i/c),l=e.codec.hex.toBits(""),f="",h=0;a>h;h++){var d=new e.misc.hmac(u,e.hash.sha256),p=e.bitArray.concat(e.bitArray.concat(l,r),e.codec.utf8String.toBits(String.fromCharCode(h+1)));d.update(p),l=d.digest(),f+=e.codec.hex.fromBits(l)}var m=e.bitArray.clamp(e.codec.hex.toBits(f),8*i);return t(m)}return n}),n("client/lib/pbkdf2",["sjcl","p"],function(e,t){"use strict";var n={derive:function(n,r,o,i){var s=e.misc.pbkdf2(n,r,o,i,e.misc.hmac);return t(s)}};return n}),n("client/lib/credentials",["./request","sjcl","p","./hkdf","./pbkdf2"],function(e,t,n,r,o){"use strict";function i(e){return t.codec.utf8String.toBits(u+e)}function s(e,n){return t.codec.utf8String.toBits(u+e+":"+n)}var u="identity.mozilla.com/picl/v1/",c=1e3,a=256,l=t.codec.hex.toBits("00"),f=32;return{setup:function(e,n){var u={},h=s("quickStretch",e),d=t.codec.utf8String.toBits(n);return u.emailUTF8=e,u.passwordUTF8=n,o.derive(d,h,c,a).then(function(e){return u.quickStretchedPW=e,r(e,i("authPW"),l,f).then(function(t){return u.authPW=t,r(e,i("unwrapBkey"),l,f)})}).then(function(e){return u.unwrapBKey=e,u})},xor:function(e,t){for(var n=[],r=0;r<e.length;r++)n[r]=e[r]^t[r];return n},unbundleKeyFetchResponse:function(e,n){var r=this,o=t.codec.hex.toBits(n);return this.deriveBundleKeys(e,"account/keys").then(function(e){var n=t.bitArray.bitSlice(o,0,512),i=t.bitArray.bitSlice(o,-256),s=new t.misc.hmac(e.hmacKey,t.hash.sha256);if(s.update(n),!t.bitArray.equal(s.digest(),i))throw new Error("Bad HMac");var u=r.xor(t.bitArray.bitSlice(o,0,512),e.xorKey);return{kA:t.codec.hex.fromBits(t.bitArray.bitSlice(u,0,256)),wrapKB:t.codec.hex.fromBits(t.bitArray.bitSlice(u,256))}})},deriveBundleKeys:function(e,n){var o=i(n),s=t.codec.hex.toBits("");return e=t.codec.hex.toBits(e),r(e,o,s,96).then(function(e){return{hmacKey:t.bitArray.bitSlice(e,0,256),xorKey:t.bitArray.bitSlice(e,256)}})}}}),n("client/lib/hawkCredentials",["sjcl","./hkdf"],function(e,t){"use strict";function n(n,s,u){var c=e.codec.hex.toBits(n),a=e.codec.utf8String.toBits(r+s);return t(c,a,i,u||96).then(function(t){var n=o(t,256,512),r=o(t,512);return{algorithm:"sha256",id:e.codec.hex.fromBits(o(t,0,256)),key:n,bundleKey:r}})}var r="identity.mozilla.com/picl/v1/",o=e.bitArray.bitSlice,i=e.codec.hex.toBits("");return n}),n("client/lib/metricsContext",[],function(){"use strict";return{marshall:function(e){return{flowId:e.flowId,flowBeginTime:e.flowBeginTime}}}}),n("client/FxAccountClient",["sjcl","p","./lib/credentials","./lib/errors","./lib/hawkCredentials","./lib/metricsContext","./lib/request"],function(e,t,n,r,o,i,s){"use strict";function u(e){return"undefined"==typeof e}function c(e){return null===e}function a(e){return"[object Object]"===Object.prototype.toString.call(e)&&!Object.keys(e).length}function l(e){return""===e}function f(e,t){if(u(e)||c(e)||a(e)||l(e))throw new Error("Missing "+t)}function h(e,t){if(!e&&!t)throw new Error("Firefox Accounts auth server endpoint or configuration object required.");if("string"!=typeof e&&(t=e||{},e=t.uri),"undefined"==typeof t&&(t={}),!e)throw new Error("FxA auth server uri not set.");m.test(e)||(e=e+"/"+p),this.request=new s(e,t.xhr,{localtimeOffsetMsec:t.localtimeOffsetMsec})}function d(e){f(e,"credentials"),f(e.oldUnwrapBKey,"credentials.oldUnwrapBKey"),f(e.keyFetchToken,"credentials.keyFetchToken"),f(e.passwordChangeToken,"credentials.passwordChangeToken")}var p="v1",m=new RegExp("/"+p+"$"),y=64;return h.VERSION=p,h.prototype.signUp=function(r,o,s){var u=this;return t().then(function(){return f(r,"email"),f(o,"password"),n.setup(r,o)}).then(function(t){var n="/account/create",r={email:t.emailUTF8,authPW:e.codec.hex.fromBits(t.authPW)},o={};return s&&(s.service&&(r.service=s.service),s.redirectTo&&(r.redirectTo=s.redirectTo),s.preVerified&&(r.preVerified=s.preVerified),s.resume&&(r.resume=s.resume),s.keys&&(n+="?keys=true"),s.lang&&(o.headers={"Accept-Language":s.lang}),s.metricsContext&&(r.metricsContext=i.marshall(s.metricsContext))),u.request.send(n,"POST",null,r,o).then(function(n){return s&&s.keys&&(n.unwrapBKey=e.codec.hex.fromBits(t.unwrapBKey)),n})})},h.prototype.signIn=function(o,s,u){var c=this;return u=u||{},t().then(function(){return f(o,"email"),f(s,"password"),n.setup(o,s)}).then(function(t){var n="/account/login";u.keys&&(n+="?keys=true");var o={email:t.emailUTF8,authPW:e.codec.hex.fromBits(t.authPW)};return u.metricsContext&&(o.metricsContext=i.marshall(u.metricsContext)),u.reason&&(o.reason=u.reason),u.redirectTo&&(o.redirectTo=u.redirectTo),u.resume&&(o.resume=u.resume),u.service&&(o.service=u.service),u.unblockCode&&(o.unblockCode=u.unblockCode),c.request.send(n,"POST",null,o).then(function(n){return u.keys&&(n.unwrapBKey=e.codec.hex.fromBits(t.unwrapBKey)),n},function(e){if(e&&e.email&&e.errno===r.INCORRECT_EMAIL_CASE&&!u.skipCaseError)return u.skipCaseError=!0,c.signIn(e.email,s,u);throw e})})},h.prototype.verifyCode=function(e,n,r){var o=this;return t().then(function(){f(e,"uid"),f(n,"verify code");var t={uid:e,code:n};return r&&(r.service&&(t.service=r.service),r.reminder&&(t.reminder=r.reminder),r.type&&(t.type=r.type),r.marketingOptIn&&(t.marketingOptIn=!0)),o.request.send("/recovery_email/verify_code","POST",null,t)})},h.prototype.recoveryEmailStatus=function(e){var n=this;return t().then(function(){return f(e,"sessionToken"),o(e,"sessionToken",y)}).then(function(e){return n.request.send("/recovery_email/status","GET",e)})},h.prototype.recoveryEmailResendCode=function(e,n){var r=this,i={},s={};return t().then(function(){return f(e,"sessionToken"),n&&(n.email&&(i.email=n.email),n.service&&(i.service=n.service),n.redirectTo&&(i.redirectTo=n.redirectTo),n.resume&&(i.resume=n.resume),n.lang&&(s.headers={"Accept-Language":n.lang})),o(e,"sessionToken",y)}).then(function(e){return r.request.send("/recovery_email/resend_code","POST",e,i,s)})},h.prototype.passwordForgotSendCode=function(e,n){var r=this,o={email:e},s={};return t().then(function(){return f(e,"email"),n&&(n.service&&(o.service=n.service),n.redirectTo&&(o.redirectTo=n.redirectTo),n.resume&&(o.resume=n.resume),n.lang&&(s.headers={"Accept-Language":n.lang}),n.metricsContext&&(o.metricsContext=i.marshall(n.metricsContext))),r.request.send("/password/forgot/send_code","POST",null,o,s)})},h.prototype.passwordForgotResendCode=function(e,n,r){var s=this,u={email:e},c={};return t().then(function(){return f(e,"email"),f(n,"passwordForgotToken"),r&&(r.service&&(u.service=r.service),r.redirectTo&&(u.redirectTo=r.redirectTo),r.resume&&(u.resume=r.resume),r.lang&&(c.headers={"Accept-Language":r.lang}),r.metricsContext&&(u.metricsContext=i.marshall(r.metricsContext))),o(n,"passwordForgotToken",y)}).then(function(e){return s.request.send("/password/forgot/resend_code","POST",e,u,c)})},h.prototype.passwordForgotVerifyCode=function(e,n,r){var s=this;return t().then(function(){return f(e,"reset code"),f(n,"passwordForgotToken"),o(n,"passwordForgotToken",y)}).then(function(t){var n={code:e};return r&&r.metricsContext&&(n.metricsContext=i.marshall(r.metricsContext)),s.request.send("/password/forgot/verify_code","POST",t,n)})},h.prototype.passwordForgotStatus=function(e){var n=this;return t().then(function(){return f(e,"passwordForgotToken"),o(e,"passwordForgotToken",y)}).then(function(e){return n.request.send("/password/forgot/status","GET",e)})},h.prototype.accountReset=function(r,s,u,c){var a,l=this,h={};return c=c||{},c.sessionToken&&(h.sessionToken=c.sessionToken),c.metricsContext&&(h.metricsContext=i.marshall(c.metricsContext)),t().then(function(){return f(r,"email"),f(s,"new password"),f(u,"accountResetToken"),c.keys&&f(c.sessionToken,"sessionToken"),n.setup(r,s)}).then(function(t){return c.keys&&(a=e.codec.hex.fromBits(t.unwrapBKey)),h.authPW=e.codec.hex.fromBits(t.authPW),o(u,"accountResetToken",y)}).then(function(e){var t="";c.keys&&(t="?keys=true");var n="/account/reset"+t;return l.request.send(n,"POST",e,h).then(function(e){return c.keys&&e.keyFetchToken&&(e.unwrapBKey=a),e})})},h.prototype.accountKeys=function(r,i){var s=this;return t().then(function(){return f(r,"keyFetchToken"),f(i,"oldUnwrapBKey"),o(r,"keyFetchToken",96)}).then(function(t){var r=e.codec.hex.fromBits(t.bundleKey);return s.request.send("/account/keys","GET",t).then(function(e){return n.unbundleKeyFetchResponse(r,e.bundle)})}).then(function(t){return{kB:e.codec.hex.fromBits(n.xor(e.codec.hex.toBits(t.wrapKB),e.codec.hex.toBits(i))),kA:t.kA}})},h.prototype.accountDestroy=function(o,i,s){var u=this;return s=s||{},t().then(function(){return f(o,"email"),f(i,"password"),n.setup(o,i)}).then(function(t){var n={email:t.emailUTF8,authPW:e.codec.hex.fromBits(t.authPW)};return u.request.send("/account/destroy","POST",null,n).then(function(e){return e},function(e){if(e&&e.email&&e.errno===r.INCORRECT_EMAIL_CASE&&!s.skipCaseError)return s.skipCaseError=!0,u.accountDestroy(e.email,i,s);throw e})})},h.prototype.accountStatus=function(e){var n=this;return t().then(function(){return f(e,"uid"),n.request.send("/account/status?uid="+e,"GET")})},h.prototype.accountStatusByEmail=function(e){var n=this;return t().then(function(){return f(e,"email"),n.request.send("/account/status","POST",null,{email:e})})},h.prototype.sessionDestroy=function(e,n){var r=this,i={};return n=n||{},n.customSessionToken&&(i.customSessionToken=n.customSessionToken),t().then(function(){return f(e,"sessionToken"),o(e,"sessionToken",y)}).then(function(e){return r.request.send("/session/destroy","POST",e,i)})},h.prototype.sessionStatus=function(e){var n=this;return t().then(function(){return f(e,"sessionToken"),o(e,"sessionToken",y)}).then(function(e){return n.request.send("/session/status","GET",e)})},h.prototype.certificateSign=function(e,n,r,i){var s=this,u={publicKey:n,duration:r};return t().then(function(){return f(e,"sessionToken"),f(n,"publicKey"),f(r,"duration"),o(e,"sessionToken",y)}).then(function(e){i=i||{};var t="";return i.service&&(t="?service="+encodeURIComponent(i.service)),s.request.send("/certificate/sign"+t,"POST",e,u)})},h.prototype.passwordChange=function(e,n,r,o){var i=this;return o=o||{},t().then(function(){return f(e,"email"),f(n,"old password"),f(r,"new password"),i._passwordChangeStart(e,n)}).then(function(t){var n=t;return i._passwordChangeKeys(n).then(function(t){return i._passwordChangeFinish(e,r,n,t,o)})})},h.prototype._passwordChangeStart=function(o,i,s){var u=this;return s=s||{},t().then(function(){return f(o,"email"),f(i,"old password"),n.setup(o,i)}).then(function(t){var n={email:t.emailUTF8,oldAuthPW:e.codec.hex.fromBits(t.authPW)};return u.request.send("/password/change/start","POST",null,n).then(function(n){return n.oldUnwrapBKey=e.codec.hex.fromBits(t.unwrapBKey),n},function(e){if(e&&e.email&&e.errno===r.INCORRECT_EMAIL_CASE&&!s.skipCaseError)return s.skipCaseError=!0,u._passwordChangeStart(e.email,i,s);throw e})})},h.prototype._passwordChangeKeys=function(e){var n=this;return t().then(function(){d(e)}).then(function(){return n.accountKeys(e.keyFetchToken,e.oldUnwrapBKey)})},h.prototype._passwordChangeFinish=function(r,i,s,u,c){c=c||{};var a=this;return t().then(function(){f(r,"email"),f(i,"new password"),d(s),f(u,"keys"),f(u.kB,"keys.kB");var e=[];return e.push(n.setup(r,i)),e.push(o(s.passwordChangeToken,"passwordChangeToken",y)),c.sessionToken&&e.push(o(c.sessionToken,"sessionToken",y)),t.all(e)}).spread(function(t,r,o){var i=e.codec.hex.fromBits(n.xor(e.codec.hex.toBits(u.kB),t.unwrapBKey)),s="";c.keys&&(s="?keys=true");var l;return o&&o.id&&(l=o.id),a.request.send("/password/change/finish"+s,"POST",r,{wrapKb:i,authPW:e.codec.hex.fromBits(t.authPW),sessionToken:l}).then(function(n){return c.keys&&n.keyFetchToken&&(n.unwrapBKey=e.codec.hex.fromBits(t.unwrapBKey)),n})})},h.prototype.getRandomBytes=function(){return this.request.send("/get_random_bytes","POST")},h.prototype.deviceRegister=function(e,n,r,i){var s=this.request;return i=i||{},t().then(function(){return f(e,"sessionToken"),f(n,"deviceName"),f(r,"deviceType"),o(e,"sessionToken",y)}).then(function(e){var t={name:n,type:r};return i.deviceCallback&&(t.pushCallback=i.deviceCallback),i.devicePublicKey&&i.deviceAuthKey&&(t.pushPublicKey=i.devicePublicKey,t.pushAuthKey=i.deviceAuthKey),s.send("/account/device","POST",e,t)})},h.prototype.deviceUpdate=function(e,n,r,i){var s=this.request;return i=i||{},t().then(function(){return f(e,"sessionToken"),f(n,"deviceId"),f(r,"deviceName"),o(e,"sessionToken",y)}).then(function(e){var t={id:n,name:r};return i.deviceCallback&&(t.pushCallback=i.deviceCallback),i.devicePublicKey&&i.deviceAuthKey&&(t.pushPublicKey=i.devicePublicKey,t.pushAuthKey=i.deviceAuthKey),s.send("/account/device","POST",e,t)})},h.prototype.deviceDestroy=function(e,n){var r=this.request;return t().then(function(){return f(e,"sessionToken"),f(n,"deviceId"),o(e,"sessionToken",y)}).then(function(e){var t={id:n};return r.send("/account/device/destroy","POST",e,t)})},h.prototype.deviceList=function(e){var n=this.request;return t().then(function(){return f(e,"sessionToken"),o(e,"sessionToken",y)}).then(function(e){return n.send("/account/devices","GET",e)})},h.prototype.sessions=function(e){var n=this.request;return t().then(function(){return f(e,"sessionToken"),o(e,"sessionToken",y)}).then(function(e){return n.send("/account/sessions","GET",e)})},h.prototype.sendUnblockCode=function(e,n){var r=this;return t().then(function(){f(e,"email");var t={email:e};return n&&n.metricsContext&&(t.metricsContext=i.marshall(n.metricsContext)),r.request.send("/account/login/send_unblock_code","POST",null,t)})},h.prototype.rejectUnblockCode=function(e,n){var r=this;return t().then(function(){f(e,"uid"),f(n,"unblockCode");var t={uid:e,unblockCode:n};return r.request.send("/account/login/reject_unblock_code","POST",null,t)})},h.prototype.sendSms=function(e,n,r,s){var u=this.request;return t().then(function(){return f(e,"sessionToken"),f(n,"phoneNumber"),f(r,"messageId"),o(e,"sessionToken",y)}).then(function(e){var t={phoneNumber:n,messageId:r},o={};return s&&(s.lang&&(o.headers={"Accept-Language":s.lang}),s.features&&(t.features=s.features),s.metricsContext&&(t.metricsContext=i.marshall(s.metricsContext))),u.send("/sms","POST",e,t,o)})},h.prototype.smsStatus=function(e,n){var r=this.request;return n=n||{},t().then(function(){return f(e,"sessionToken"),o(e,"sessionToken",y)}).then(function(e){var t="/sms/status";return n.country&&(t+="?country="+encodeURIComponent(n.country)),r.send(t,"GET",e)})},h.prototype.consumeSigninCode=function(e,n,r){var o=this;return t().then(function(){return f(e,"code"),f(n,"flowId"),f(r,"flowBeginTime"),o.request.send("/signinCodes/consume","POST",null,{code:e,metricsContext:{flowId:n,flowBeginTime:r}})})},h.prototype.recoveryEmails=function(e){var n=this.request;return t().then(function(){return f(e,"sessionToken"),o(e,"sessionToken",y)}).then(function(e){return n.send("/recovery_emails","GET",e)})},h.prototype.recoveryEmailCreate=function(e,n){var r=this.request;return t().then(function(){return f(e,"sessionToken"),f(e,"email"),o(e,"sessionToken",y)}).then(function(e){
var t={email:n};return r.send("/recovery_email","POST",e,t)})},h.prototype.recoveryEmailDestroy=function(e,n){var r=this.request;return t().then(function(){return f(e,"sessionToken"),f(e,"email"),o(e,"sessionToken",y)}).then(function(e){var t={email:n};return r.send("/recovery_email/destroy","POST",e,t)})},h.prototype.recoveryEmailSecondaryEmailEnabled=function(e){var n=this.request;return t().then(function(){return f(e,"sessionToken"),o(e,"sessionToken",y)}).then(function(e){return n.send("/recovery_email/check_can_add_secondary_address","GET",e)})},h.prototype._required=f,h}),e("client/FxAccountClient")});
//# sourceMappingURL=fxa-client.min.js.map